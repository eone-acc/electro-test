import{getLocalStorage,setLocalStorage}from"./storage.js";const dbUrl="../db/db.json",userName=document.querySelector(".nav__user-info"),timerShow=document.querySelector(".timer"),prevBtn=document.querySelector(".prev-btn"),nextBtn=document.querySelector(".next-btn"),submitBtn=document.querySelector(".submit-btn"),controllButton=document.querySelector(".controll-block__button");let timer;const mainSection=document.querySelector(".main-section");let answerListElements;mainSection.style.display="none";let storageData,questionLenght,testSettings={},quantityInOneTest=10,currentQuestionIndex=0,timeToTestCompleate=10,currentQuestionData={},currentQuestionUserData={},finished=!1,totalTimer=0,stat=[0,0];const createNewUser=()=>{setLocalStorage("userLocalData",{name:"",time:10,questionQuantity:10,totalTestCompleate:0,averageScore:0,lastTestScore:[0,0],testedNow:!1})},pushDataOfDBToStorage=async()=>{await fetch(dbUrl).then(e=>e.json()).then(e=>{let t=[],n=[],r=0;e.forEach(e=>{e.data.forEach(n=>{n.questionCharpter=e.testCharpter,n.qID=r,r++,t.push(n)})});for(let e in[...Array(quantityInOneTest).keys()]){let e=t[Math.floor(Math.random()*t.length)];n.includes(e)&&(e=t[Math.floor(Math.random()*t.length)],console.log("havesomeone")),n.push(e)}return setLocalStorage("allQuestion",n),t}).catch(e=>console.log("Ошибка",e))},renderQuestion=async e=>{currentQuestionData.qID=e.qID;let t=[];e.answerText.forEach((e,n)=>{"true"===e.isCorrect&&t.push(n)}),currentQuestionData.correctAnswer=t;const n=document.querySelector(".question-block");n.innerHTML="";let r="";for(let[t,n]of e.answerText.entries())r+=`\n      <div class="question-body__item" data-answer-index = ${t}>\n        <span>${+n.num+1}.</span>\n        <p>${n.text}</p>\n      </div>\n    `;let o=` \n    <div class="question-header">\n      <div class="question-header__commit"><div class="question-header__tick"></div> </div>\n      <div class="question-header__question">\n        <div class="question-header__question-title"><h3>${e.questionCharpter}</h3></div>\n        <div class="question-header__text"><p>${e.questionName}</p></div>\n        <div class="question-header__text"><p>${e.questionText}</p></div>\n      </div>\n      <div class="question-header__eachof"><span>${currentQuestionIndex+1} из ${questionLenght}</span></div>\n      </div>\n      <div class="question-body">\n        ${r}\n      </div>\n  `;n.innerHTML=await o},reRenderCurrentQuestion=async e=>{if(getLocalStorage("userData").length===getLocalStorage("allQuestion").length&&(finished=!0,totalTimer=0,controllButton.innerText="Еще раз",0!==await getLocalStorage("finishedData").length&&(timerShow.style.minWidth="400px",timerShow.innerHTML=`<span>Вы правильно ответили на ${getLocalStorage("finishedData")[0]} из ${getLocalStorage("finishedData")[1]} вопросов!</span>`)),await renderQuestion(storageData[e]),answerListElements=document.querySelectorAll(".question-body__item"),finished){const e=await finishTest().userAnswers.filter(e=>e.qID===currentQuestionData.qID),t=await finishTest().correctData.filter(e=>e.qID===currentQuestionData.qID);checkAnwser(t[0].answerText,e[0].userAnswers)}else if(answerListElements){const e=ifUserAllreadyConfirmAnswer();e.length>0?markingConfirmedAns(e):answerListElements.forEach(e=>{e.addEventListener("click",()=>{e.classList.toggle("question-body__item-checked")})})}},arrayCompare=(e,t)=>{if(e=e.sort(),t=t.sort(),e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0},ifUserAllreadyConfirmAnswer=()=>getLocalStorage("userData").filter(e=>e.qID===currentQuestionData.qID),markingConfirmedAns=e=>{document.querySelector(".question-header__tick").style.opacity="1",answerListElements.forEach(t=>{e[0].userAnswers.includes(+t.dataset.answerIndex)&&t.classList.toggle("question-body__item-checked")})},appendToStorage=async(e,t)=>{let n=await getLocalStorage(e),r=[];0===n.length?(r.push(t),setLocalStorage(e,r)):(r=[],n.forEach(e=>{r.push(e)}),r.push(t),setLocalStorage(e,r))},finishTest=()=>{let e=getLocalStorage("userData");const t=getLocalStorage("allQuestion");let n=[],r=[];if(t.forEach(e=>{delete e.questionCharpter,delete e.questionText,delete e.questionName,e.answerText.forEach(e=>{"true"===e.isCorrect&&r.push(+e.num)}),e.answerText=r,n.push(e),r=[]}),e.length!=n.length){let t=[];e.forEach(e=>{t.push(e.qID)}),n.forEach(n=>{t.includes(n.qID)||e.push({qID:n.qID,userAnswers:[]})})}if(0===getLocalStorage("finishedData").length){let t,r,o=[0,0];n.forEach(n=>{t=n.answerText,r=e.filter(e=>e.qID===n.qID)[0].userAnswers,arrayCompare(t,r)?(o[0]+=1,o[1]+=1):o[1]+=1}),setLocalStorage("finishedData",o)}return{userAnswers:e,correctData:n}},checkAnwser=(e,t)=>{const n=document.querySelector(".question-header__tick");if(e.forEach(e=>{document.querySelector(`[data-answer-index="${e}"]`).classList.add("question-body__item-correct")}),e.length===t.length){let r=t.filter(t=>!e.includes(t));0===r.length?(n.style.opacity="1",n.style.backgroundColor="green"):r.length>0&&r.forEach(e=>{document.querySelector(`[data-answer-index="${e}"]`).classList.add("question-body__item-wrong"),n.style.opacity="1",n.style.backgroundColor="red"})}else{t.filter(t=>!e.includes(t)).forEach(e=>{document.querySelector(`[data-answer-index="${e}"]`).classList.add("question-body__item-wrong"),n.style.opacity="1",n.style.backgroundColor="red"})}},testTimer=()=>{let e=totalTimer%60,t=totalTimer/60%60;if(totalTimer<=0)stopTesting();else{totalTimer>60?(timerShow.style.color="black",timerShow.style.fontWeight="regular"):(timerShow.style.color="red",timerShow.style.fontWeight="bold");let n=`${Math.trunc(t)<10?"0"+Math.trunc(t):Math.trunc(t)}:${e<10?"0"+e:e}`;timerShow.innerHTML=`<span>${n}</span>`,timerShow.style.minWidth="50px"}--totalTimer},startTesting=async()=>{controllButton.closest(".controll-block").classList.remove("controll-block--zoomed"),mainSection.style.display="block",finished&&(localStorage.removeItem("userData"),finished=!1,await pushDataOfDBToStorage(),currentQuestionIndex=0),setLocalStorage("timerSet",(new Date).getTime()+6e5),totalTimer=await Math.round((getLocalStorage("timerSet")-(new Date).getTime())/1e3),timer=setInterval(testTimer,1e3),storageData=getLocalStorage("allQuestion"),reRenderCurrentQuestion(currentQuestionIndex),controllButton.innerText="Завершить",testSettings.testedNow=!0,await setLocalStorage("userLocalData",testSettings),localStorage.removeItem("finishedData")},stopTesting=async()=>{clearInterval(timer),await localStorage.removeItem("timerSet"),mainSection.style.display="block",controllButton.innerText="Еще раз",testSettings.testedNow=!1,await setLocalStorage("userLocalData",testSettings),finished=!0,await reRenderCurrentQuestion(currentQuestionIndex),0!==getLocalStorage("finishedData").length&&(timerShow.style.color="black",timerShow.style.fontWeight="regular",timerShow.style.minWidth="400px",timerShow.innerHTML=`<span>Вы правильно ответили на ${getLocalStorage("finishedData")[0]} из ${getLocalStorage("finishedData")[1]} вопросов!</span>`)},initialize=async()=>{testSettings=getLocalStorage("userLocalData"),userName.innerText=testSettings.name,0===await getLocalStorage("allQuestion").length?(await pushDataOfDBToStorage(),questionLenght=getLocalStorage("allQuestion").length,storageData=getLocalStorage("allQuestion")):(questionLenght=getLocalStorage("allQuestion").length,storageData=getLocalStorage("allQuestion"),reRenderCurrentQuestion(currentQuestionIndex),finished&&(controllButton.closest(".controll-block").classList.remove("controll-block--zoomed"),mainSection.style.display="block")),testSettings.testedNow?controllButton.innerText="Завершить":controllButton.innerText="Начать",controllButton.addEventListener("click",async()=>{testSettings.testedNow?testSettings.testedNow&&(console.log("STOPED"),stopTesting()):(console.log("STARTED"),startTesting()),testSettings.testedNow=!testSettings.testedNow})};function toggleFullScreen(){var e=window.document,t=e.documentElement,n=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen||t.msRequestFullscreen,r=e.exitFullscreen||e.mozCancelFullScreen||e.webkitExitFullscreen||e.msExitFullscreen;e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement?r.call(e):n.call(t)}localStorage.length>0&&localStorage.clear(),0===getLocalStorage("userLocalData").length?(localStorage.clear(),setLocalStorage("userLocalData",{name:"",time:10,questionQuantity:10,totalTestCompleate:0,averageScore:0,lastTestScore:[0,0],testedNow:!1}),initialize()):initialize(),prevBtn.addEventListener("click",async()=>{0!==currentQuestionIndex&&(currentQuestionIndex--,await reRenderCurrentQuestion(currentQuestionIndex))}),nextBtn.addEventListener("click",async()=>{currentQuestionIndex+1!==questionLenght&&(currentQuestionIndex++,await reRenderCurrentQuestion(currentQuestionIndex))}),submitBtn.addEventListener("click",async()=>{const e=document.querySelectorAll(".question-body__item-checked");if(getLocalStorage("userData").length!==getLocalStorage("allQuestion").length){if(!(e.length>0))return void alert("Выберите вариант ответа!");{let t=[];if(e.forEach(e=>{t.push(+e.dataset.answerIndex)}),currentQuestionUserData={},currentQuestionUserData.qID=currentQuestionData.qID,currentQuestionUserData.userAnswers=t,ifUserAllreadyConfirmAnswer().length>0)return;await appendToStorage("userData",currentQuestionUserData)}if(currentQuestionIndex+1===questionLenght)return void reRenderCurrentQuestion(currentQuestionIndex);currentQuestionIndex++,reRenderCurrentQuestion(currentQuestionIndex)}}),toggleFullScreen();